name: RAPx

on:
  workflow_dispatch:
  push:
    branches: [main,rapx-dev]
  pull_request:
    branches: [main,rapx-dev]

env:
  RAPx_VERSION: "aa0a567fd080fbb5ab1ece4740bad3b5665ca514"

jobs:
  check-with-rapx:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Clone RAPx
        run: |
          git clone https://github.com/Artisan-Lab/RAPx.git
          cd RAPx
          git checkout $RAPX_VERSION

      - name: Install RAPx
        run: |
          cd RAPx
          ./install.sh

      - name: Set up RAPx environment
        run: |
            RUSTUP_TOOLCHAIN=$(rustup show active-toolchain | cut -d ' ' -f 1)
            echo "RUSTUP_TOOLCHAIN=$RUSTUP_TOOLCHAIN" >> $GITHUB_ENV
            CURRENT_DIR=$(pwd)
            RUST_SRC_PATH="$CURRENT_DIR/library"
            echo "__CARGO_TESTS_ONLY_SRC_ROOT=$RUST_SRC_PATH" >> $GITHUB_ENV

      - name: Run RAPx Verification
        run: |
          cargo new dummy_crate
          cd dummy_crate
          cargo +$RUSTUP_TOOLCHAIN rapx -verify-std -- -Zbuild-std=panic_abort,core,std --target x86_64-unknown-linux-gnu